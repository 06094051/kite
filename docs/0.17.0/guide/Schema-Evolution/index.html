<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Schema Evolution</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Documentation for the Kite open source project on GitHub.">
    <link rel="canonical" href="http://kitesdk.org/docs/current/guide/Schema-Evolution/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/docs/current/guide/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/docs/current/guide/">Kite SDK Development Guide</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <!--div class="trigger">
        
          <a class="page-link" href="/docs/current/guide/Column-Mapping/">Column Mapping</a>
        
          <a class="page-link" href="/docs/current/guide/HBase-Storage-Cells/">HBase Storage Cells</a>
        
          <a class="page-link" href="/docs/current/guide/Inferring-a-Schema-from-a-Java-Class/">Inferring a Schema from a Java Class</a>
        
          <a class="page-link" href="/docs/current/guide/Inferring-a-Schema-from-an-Avro-Data-File/">Inferring a Schema from an Avro Data File</a>
        
          <a class="page-link" href="/docs/current/guide/Install-Kite/">Install the Kite Command Line Interface</a>
        
          <a class="page-link" href="/docs/current/guide/Interval-Notation/">Interval Notation</a>
        
          <a class="page-link" href="/docs/current/guide/Kite-Data-Module-Overview/">Kite Data Module Overview</a>
        
          <a class="page-link" href="/docs/current/guide/Kite-Dataset-Command-Line-Interface/">Kite Dataset Command Line Interface</a>
        
          <a class="page-link" href="/docs/current/guide/Kite-SDK-Guide/">What is Kite?</a>
        
          <a class="page-link" href="/docs/current/guide/Parquet-vs-Avro-Format/">Parquet vs Avro Format</a>
        
          <a class="page-link" href="/docs/current/guide/Partition-Strategy-Format/">Partition Strategy JSON Format</a>
        
          <a class="page-link" href="/docs/current/guide/Partitioned-Datasets/">Partitioned Datasets</a>
        
          <a class="page-link" href="/docs/current/guide/Restricted-Views/">Restricted Views</a>
        
          <a class="page-link" href="/docs/current/guide/Schema-Evolution/">Schema Evolution</a>
        
          <a class="page-link" href="/docs/current/guide/Schema-URL-Warning/">Schema URL Warning</a>
        
          <a class="page-link" href="/docs/current/guide/URIs/">Dataset and View URIs</a>
        
          <a class="page-link" href="/docs/current/guide/Using-Kite-with-Apache-Maven/"></a>
        
          <a class="page-link" href="/docs/current/guide/Using-the-Kite-CLI-to-Create-a-Dataset/">Using the Kite Command Line Interface to Create a Dataset</a>
        
          <a class="page-link" href="/docs/current/guide/Viewing-with-Impala/">Viewing a Kite CLI Dataset with Impala</a>
        
          <a class="page-link" href="/docs/current/guide/about/">About Kite SDK</a>
        
          <a class="page-link" href="/docs/current/guide/feed.xml"></a>
        
          <a class="page-link" href="/docs/current/guide/">Kite SDK Documentation</a>
        
          <a class="page-link" href="/docs/current/guide/lifecycle/">Kite Dataset Lifecycle</a>
        
      </div -->
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Schema Evolution</h1>
  </header>

  <article class="post-content">
  <p>Over time, you might want to add or remove fields in an existing schema. The precise rules for schema evolution are inherited from Avro, and are documented in the Avro specification as rules for <a href="http://avro.apache.org/docs/current/spec.html#Schema+Resolution" title="schemaSpec">Avro schema resolution</a>. For the purposes of working in Kite, here are some important things to note.</p>

<h2 id="writer-schemas-and-reader-schemas">Writer Schemas and Reader Schemas</h2>

<p>Writer schemas describe a dataset as it is being written. Reader schemas describe a dataset as it is being read from a datastore. Writer and reader schemas must be compatible, but they do not have to match exactly. See the <a href="http://avro.apache.org/docs/current/spec.html#Schema+Resolution" title="schemaSpec">Avro schema resolution</a> specification for the exhaustive list of rules for matching one schema to another.</p>

<h2 id="changing-field-types">Changing Field Types</h2>

<p>You can use schema resolution to change the type used to store a value. For example, you can change an <code>int</code> to a <code>long</code> to handle values that grow larger than initially anticipated.</p>

<h2 id="removing-fields-from-a-dataset">Removing Fields from a Dataset</h2>

<p>When you remove fields from a dataset schema, the data already written remains unchanged. The fields you remove are not required when records are written going forward. The field must not be added back, unless it is identical to the existing field (since the data isn’t actually removed from the dataset).</p>

<h2 id="adding-fields-to-a-dataset">Adding Fields to a Dataset</h2>

<p>You can add fields to a dataset’s schema, provided the the schema is compatible with the existing data. If you do so, you must define a default value for the fields you add to the dataset schema. New data that includes the field will be populated normally. Records that do not include the field are populated with the default you provide.</p>

<h2 id="reading-with-different-schemas">Reading with Different Schemas</h2>

<p>You can have a schema that reads fewer fields than are defined by the schema used to write a dataset, provided that the field definitions in the reader schema are compatible with the chosen fields in the writer schema. This is useful when the writer schema provides more fields than are needed for the business case supported by the reader schema.</p>

<p>Removing unnecessary fields allows Kite to read data more efficiently. The performance gain can be significant when using Parquet format, in particular.</p>

<p>Kite ensures that each change to a schema is compatible with the last version of the schema. Older data can always be read by the current schema.</p>

<h2 id="example-of-schema-evolution">Example of Schema Evolution</h2>

<p>Here’s an example that demonstrates how to use the Kite CLI to update the schema for a movies dataset. Complete sample data is available in <a href="../samples/movies.tar.gz">movies.tar.gz</a>.</p>

<p>Begin with a CSV data file (movies.csv).</p>

<pre><code>id,title
1,Anticoagulance
2,"Boy and His Cattle, A"
3,Carpool to Vermont
</code></pre>

<p>Generate an Avro schema file (<code>movies.avsc</code>) using <code>movies.csv</code>.</p>

<pre><code>$ kite-dataset csv-schema movies.csv --class movies -o movies.avsc
</code></pre>

<p>The schema <code>movies.avsc</code> describes fields for <em>id</em> number and the <em>title</em> of the movie.</p>

<pre><code>{
  "type" : "record",
  "name" : "movie",
  "doc" : "Schema generated by Kite",
  "fields" : [ {
    "name" : "id",
    "type" : [ "null", "long" ],
    "doc" : "Type inferred from \"1\""
  }, {
    "name" : "title",
    "type" : [ "null", "string" ],
    "doc" : "Type inferred from \"Anticoagulance\""
  } ]
}
</code></pre>

<p>Create the <em>movies</em> dataset.</p>

<pre><code>$ kite-dataset create movies --schema movies.avsc
</code></pre>

<p>Import the CSV data.</p>

<pre><code>$ kite-dataset csv-import movies.csv movies
</code></pre>

<p>Validate the dataset by showing the first few records.</p>

<pre><code>$ kite-dataset show movies
{"id": 1, "title": "Anticoagulance"}
{"id": 2, "title": "Boy and His Cattle, A"}
{"id": 3, "title": "Carpool to Vermont"}
</code></pre>

<p>Now that you’ve created your dataset, you immediately receive a request from your director to add a field for a movie rating, 1 through 5. Sigh. You modify the Avro schema file to add the <em>rating</em> field. When you add a new field, you must provide a default value that is used to fill in the field for existing records.</p>

<p>In this case, the default value is <em>null</em>. Note that you don’t put quotation marks around <em>null</em> when setting it as the default value.</p>

<p>The source code for this file is <code>movies2.avsc</code>.</p>

<pre><code>{
  "type" : "record",
  "name" : "movies",
  "doc" : "Schema generated by Kite",
  "fields" : [ {
    "name" : "id",
    "type" : [ "null", "long" ],
    "doc" : "Type inferred from '1'"
  }, {
    "name" : "title",
    "type" : [ "null", "string" ],
    "doc" : "Type inferred from 'Anticoagulance'"
  }, {
    "name" : "rating",
    "type" : [ "null", "long"],
    "default" : null,
    "doc" : "Movie rating."
  } ]
}
</code></pre>

<p>Use the CLI <code>update</code> command to add the new field.</p>

<pre><code>$ kite-dataset update movies --schema movies2.avsc
</code></pre>

<p>Now you can load more records that include values for the <em>rating</em> field.  These records are in the file <code>movies2.csv</code>.</p>

<pre><code>id,title,rating
4,Chameleon Chameleon,5
5,Champion of Mediocrity,3
6,Chest Pains,1

</code></pre>

<p>After you import <code>movies2.csv</code>, the existing records display <em>null</em> for the <em>rating</em> field.</p>

<pre><code>$ kite-dataset csv-import movies2.csv movies
Added 3 records to "movies"
$ kite-dataset show movies
{"id": 1, "title": "Anticoagulance", "rating": null}
{"id": 2, "title": "Boy and His Cattle, A", "rating": null}
{"id": 3, "title": "Carpool to Vermont", "rating": null}
{"id": 4, "title": "Chameleon Chameleon", "rating": 5}
{"id": 5, "title": "Champion of Mediocrity", "rating": 3}
{"id": 6, "title": "Chest Pains", "rating": 1}
</code></pre>

<p>What a complete and satisfying movies dataset. But not so fast. Your director realizes that the <em>rating</em> field should actually allow decimals to store the average ratings from multiple reviewers.</p>

<p>Update the schema definition, changing the <em>rating</em> field datatype from <em>long</em> to <em>double</em>. The source code for this file is <code>movies3.avsc</code>.</p>

<pre><code>{
  "type" : "record",
  "name" : "movies",
  "doc" : "Schema generated by Kite",
  "fields" : [ {
    "name" : "id",
    "type" : [ "null", "long" ],
    "doc" : "Type inferred from '1'"
  }, {
    "name" : "title",
    "type" : [ "null", "string" ],
    "doc" : "Type inferred from 'Anticoagulance'"
  }, {
    "name" : "rating",
    "type" : [ "null", "double" ],
    "default" : null,
    "doc" : "Movie rating."
  } ]
}
</code></pre>

<p>Once again, update the schema.</p>

<pre><code>$ kite-dataset update movies --schema movies3.avsc
</code></pre>
<p>If you run the <code>show</code> command, you’ll see that the existing integer <em>id</em> field values now display values with a decimal point and 0.</p>

<pre><code>$ kite-dataset show movies
{"id": 1, "title": ""Anticoagulance", "rating": null}
{"id": 2, "title": "Boy and His Cattle, A", "rating": null}
{"id": 3, "title": "Carpool to Vermont", "rating": null}
{"id": 4, "title": "Chameleon Chameleon", "rating": 5.0}
{"id": 5, "title": "Champion of Mediocrity", "rating": 3.0}
{"id": 6, "title": "Chest Pains", "rating": 1.0}

</code></pre>
<p>The <em>rating</em> values are small, and could easily fit into a <em>float</em> datatype. However, the current datatype is <em>long</em>. You have to convert the field to a <em>double</em> datatype, because the highest potential value in a <em>long</em> integer is too high to store in a <em>float</em> field.</p>

<p>The datafile <code>movies3.csv</code> contains records with decimal <em>rating</em> numbers.</p>

<pre><code>id,title,rating
7,Chuck Maggot,2.5
8,"Cock Crows Thrice, The",3.2
9,Cormack!,4.75
</code></pre>

<p>Import the records and show the table.</p>

<pre><code>$ kite-dataset csv-import movies3.csv movies
Added 3 records to "movies"
$ kite-dataset show movies
{"id": 1, "title": "Anticoagulance", "rating": null}
{"id": 2, "title": "Boy and His Cattle, A", "rating": null}
{"id": 3, "title": "Carpool to Vermont", "rating": null}
{"id": 4, "title": "Chameleon Chameleon", "rating": 5.0}
{"id": 5, "title": "Champion of Mediocrity", "rating": 3.0}
{"id": 6, "title": "Chest Pains", "rating": 1.0}
{"id": 7, "title": "Chuck Maggot", "rating": 2.5}
{"id": 8, "title": "Cock Crows Thrice, The", "rating": 3.2}
{"id": 9, "title": "Cormack!", "rating": 4.75}
</code></pre>

<p>See <a href="http://avro.apache.org/docs/current/spec.html#Schema+Resolution" title="schemaSpec">Avro schema resolution</a> for further options.</p>


  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Kite SDK Development Guide</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>Kite SDK Development Guide</li>
        <li><a href="mailto:cdk-dev@cloudera.org">cdk-dev@cloudera.org</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">Documentation for the Kite open source project on GitHub.</p>
    </div>

  </div>

</footer>


    </body>
</html>